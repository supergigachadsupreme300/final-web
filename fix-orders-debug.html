<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug & Fix Orders</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        pre {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        .success {
            background: #4caf50;
        }
        .danger {
            background: #f44336;
        }
        .log {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }
        .error {
            color: #f44336;
        }
        .success-msg {
            color: #4caf50;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Debug & Fix Orders Tool</h1>
    
    <div class="card">
        <h2>1. Current Status</h2>
        <button onclick="showStatus()">ğŸ“Š Show Current Data</button>
        <button onclick="showInvalidOrders()">âš ï¸ Show Invalid Orders</button>
        <button onclick="showOrderStructure()">ğŸ” Show Order Structure</button>
        <pre id="status-output"></pre>
    </div>

    <div class="card">
        <h2>2. Fix Actions</h2>
        <button class="success" onclick="fixAllOrders()">âœ… Fix All Invalid Dates</button>
        <button class="success" onclick="syncEndUsers()">ğŸ”„ Sync End-User â†’ Admin</button>
        <button class="danger" onclick="clearInvalidOrders()">ğŸ—‘ï¸ Delete Invalid Orders</button>
        <pre id="fix-output"></pre>
    </div>

    <div class="card">
        <h2>3. Console Logs</h2>
        <div id="console-log"></div>
    </div>

    <script>
        const log = (message, isError = false) => {
            const logDiv = document.getElementById('console-log');
            const p = document.createElement('p');
            p.className = isError ? 'log error' : 'log success-msg';
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        function showStatus() {
            const output = document.getElementById('status-output');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            let totalOrders = 0;
            let invalidOrders = 0;
            let pendingOrders = 0;
            let ordersWithoutProducts = 0;
            
            users.forEach(user => {
                if (user.orders) {
                    totalOrders += user.orders.length;
                    user.orders.forEach(order => {
                        if (!order.orderTime || order.orderTime === 'Invalid Date' || isNaN(new Date(order.orderTime).getTime())) {
                            invalidOrders++;
                        }
                        if (order.isVerify === 0) {
                            pendingOrders++;
                        }
                        if (!order.products || order.products.length === 0) {
                            ordersWithoutProducts++;
                        }
                    });
                }
            });
            
            output.textContent = `ğŸ“Š CURRENT STATUS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Total Users: ${users.length}
Total Orders: ${totalOrders}
Pending Orders: ${pendingOrders}
Invalid Orders: ${invalidOrders}
Orders without Products: ${ordersWithoutProducts}

End-User Accounts (user_*):`;

            // Check end-user accounts
            let endUserCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('user_') && key !== 'users') {
                    endUserCount++;
                    const userData = JSON.parse(localStorage.getItem(key));
                    output.textContent += `\n  - ${key}: ${userData.orders ? userData.orders.length : 0} orders`;
                }
            }
            output.textContent += `\n\nTotal End-User Accounts: ${endUserCount}`;
            
            log(`Status check complete: ${totalOrders} orders, ${invalidOrders} invalid, ${ordersWithoutProducts} without products`);
        }

        function showInvalidOrders() {
            const output = document.getElementById('status-output');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            let invalidOrdersList = [];
            
            users.forEach(user => {
                if (user.orders) {
                    user.orders.forEach(order => {
                        if (!order.orderTime || order.orderTime === 'Invalid Date' || isNaN(new Date(order.orderTime).getTime())) {
                            invalidOrdersList.push({
                                username: user.username,
                                code: order.code || 'N/A',
                                orderTime: order.orderTime,
                                date: order.date,
                                status: order.isVerify
                            });
                        }
                    });
                }
            });
            
            output.textContent = `âš ï¸ INVALID ORDERS (${invalidOrdersList.length}):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
` + JSON.stringify(invalidOrdersList, null, 2);
            
            log(`Found ${invalidOrdersList.length} invalid orders`, invalidOrdersList.length > 0);
        }

        function showOrderStructure() {
            const output = document.getElementById('status-output');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            let sampleOrder = null;
            for (const user of users) {
                if (user.orders && user.orders.length > 0) {
                    sampleOrder = {
                        username: user.username,
                        order: user.orders[0]
                    };
                    break;
                }
            }
            
            if (sampleOrder) {
                output.textContent = `ğŸ” SAMPLE ORDER STRUCTURE:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
User: ${sampleOrder.username}
Order Code: ${sampleOrder.order.code}

` + JSON.stringify(sampleOrder.order, null, 2);
                log('Showing sample order structure');
            } else {
                output.textContent = 'âŒ No orders found!';
                log('No orders to show', true);
            }
        }

        function fixAllOrders() {
            const output = document.getElementById('fix-output');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            let fixedCount = 0;
            
            users.forEach(user => {
                if (user.orders && Array.isArray(user.orders)) {
                    user.orders.forEach(order => {
                        // Check if orderTime is invalid
                        if (!order.orderTime || order.orderTime === 'Invalid Date' || isNaN(new Date(order.orderTime).getTime())) {
                            // Try to parse from date field
                            if (order.date) {
                                try {
                                    // Convert Vietnamese date string to ISO
                                    const dateParts = order.date.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})[,\s]+(\d{1,2}):(\d{2}):(\d{2})/);
                                    if (dateParts) {
                                        const [, day, month, year, hour, minute, second] = dateParts;
                                        order.orderTime = new Date(year, month - 1, day, hour, minute, second).toISOString();
                                        fixedCount++;
                                        log(`âœ… Fixed order ${order.code}: ${order.orderTime}`);
                                    } else {
                                        order.orderTime = new Date().toISOString();
                                        fixedCount++;
                                        log(`âš ï¸ Set current time for order ${order.code}`);
                                    }
                                } catch (e) {
                                    order.orderTime = new Date().toISOString();
                                    fixedCount++;
                                    log(`âš ï¸ Error fixing order ${order.code}`, true);
                                }
                            } else {
                                order.orderTime = new Date().toISOString();
                                fixedCount++;
                                log(`âš ï¸ No date for order ${order.code}, using current time`);
                            }
                        }
                    });
                }
            });
            
            if (fixedCount > 0) {
                localStorage.setItem('users', JSON.stringify(users));
                output.textContent = `âœ… Fixed ${fixedCount} orders successfully!`;
                log(`Fixed ${fixedCount} orders and saved to localStorage`);
            } else {
                output.textContent = 'âœ… No invalid orders found!';
                log('No invalid orders to fix');
            }
        }

        function syncEndUsers() {
            const output = document.getElementById('fix-output');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            let syncedCount = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                if (key && key.startsWith('user_') && key !== 'users') {
                    const username = key.replace('user_', '');
                    const userData = JSON.parse(localStorage.getItem(key));
                    
                    let user = users.find(u => u.username === username);
                    
                    if (!user) {
                        // Create new user
                        user = {
                            username: username,
                            password: userData.password || '',
                            email: userData.email || 'N/A',
                            name: userData.name || username,
                            phone: userData.phone || 'N/A',
                            address: userData.address || '',
                            DOB: userData.DOB || '',
                            isAdmin: false,
                            isLocked: false,
                            orders: [],
                            joinDate: new Date().toISOString()
                        };
                        users.push(user);
                        syncedCount++;
                        log(`âœ… Created user: ${username}`);
                    }
                    
                    // Sync orders
                    if (userData.orders && Array.isArray(userData.orders)) {
                        userData.orders.forEach(newOrder => {
                            const orderExists = user.orders.some(o => {
                                if (newOrder.code && o.code) return o.code === newOrder.code;
                                if (newOrder.orderTime && o.orderTime) return o.orderTime === newOrder.orderTime;
                                return false;
                            });
                            
                            if (!orderExists) {
                                const products = JSON.parse(localStorage.getItem('products') || '[]');
                                
                                const adminOrder = {
                                    code: newOrder.code || 'DH' + Math.floor(Math.random() * 90000 + 10000),
                                    orderTime: newOrder.orderTime || new Date().toISOString(),
                                    infoUser: {
                                        name: userData.name || user.name,
                                        phone: userData.phone || user.phone,
                                        address: newOrder.address || userData.address || 'N/A'
                                    },
                                    paymentMethod: newOrder.payment || 'Tiá»n máº·t',
                                    note: newOrder.note || '',
                                    products: newOrder.items ? newOrder.items.map(item => {
                                        const product = products.find(p => p.name === item.name);
                                        return {
                                            id: product?.id || 0,
                                            name: item.name,
                                            image: product?.image || '',
                                            category: product?.category || '',
                                            price: item.price,
                                            qty: item.qty || 1,
                                            volume: product?.volume || ''
                                        };
                                    }) : [],
                                    totalPrice: newOrder.items ? newOrder.items.reduce((sum, i) => sum + (i.price * (i.qty || 1)), 0) : 0,
                                    isVerify: newOrder.status === 'ÄÃ£ xÃ¡c nháº­n' ? 1 : newOrder.status === 'ÄÃ£ há»§y' ? -1 : 0
                                };
                                
                                user.orders.push(adminOrder);
                                syncedCount++;
                                log(`âœ… Synced order ${adminOrder.code} for ${username}`);
                            }
                        });
                    }
                }
            }
            
            if (syncedCount > 0) {
                localStorage.setItem('users', JSON.stringify(users));
                output.textContent = `âœ… Synced ${syncedCount} items successfully!`;
                log(`Synced ${syncedCount} items to admin panel`);
            } else {
                output.textContent = 'âœ… All data already synced!';
                log('No new data to sync');
            }
        }

        function clearInvalidOrders() {
            if (!confirm('âš ï¸ Are you sure? This will DELETE all orders with Invalid Date!')) {
                return;
            }
            
            const output = document.getElementById('fix-output');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            let deletedCount = 0;
            
            users.forEach(user => {
                if (user.orders && Array.isArray(user.orders)) {
                    const validOrders = user.orders.filter(order => {
                        const isValid = order.orderTime && order.orderTime !== 'Invalid Date' && !isNaN(new Date(order.orderTime).getTime());
                        if (!isValid) {
                            deletedCount++;
                            log(`ğŸ—‘ï¸ Deleted order ${order.code || 'N/A'}`, true);
                        }
                        return isValid;
                    });
                    user.orders = validOrders;
                }
            });
            
            if (deletedCount > 0) {
                localStorage.setItem('users', JSON.stringify(users));
                output.textContent = `ğŸ—‘ï¸ Deleted ${deletedCount} invalid orders!`;
                log(`Deleted ${deletedCount} invalid orders`);
            } else {
                output.textContent = 'âœ… No invalid orders to delete!';
                log('No invalid orders found');
            }
        }

        // Auto show status on load
        window.addEventListener('load', () => {
            log('Debug tool loaded');
            showStatus();
        });
    </script>
</body>
</html>
